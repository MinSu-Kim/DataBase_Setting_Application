-- db 존재하면 삭제
drop database if exists coffee2;

-- db 생성
create database coffee2;

-- db 선택
use coffee2;

-- 제품
CREATE TABLE product (
	code  CHAR(4)     NOT NULL primary key COMMENT '코드', -- 코드
	name  VARCHAR(20) NOT NULL COMMENT '제품명' -- 제품명
);

-- 판매정보
CREATE TABLE sale (
	no         INT(11) NOT NULL auto_increment primary key COMMENT '번호', -- 번호
	code       CHAR(4) NOT NULL COMMENT '제품코드', -- 제품코드
	price INT(11)     NOT NULL COMMENT '제품단가', -- 제품단가
	saleCnt    INT(11) NOT NULL COMMENT '판매량', -- 판매량
	marginRate INT(11) NOT NULL COMMENT '마진율', -- 마진율
	foreign key (code) references product(code)
);

-- 판매세부정보
CREATE TABLE saledetail (
   no           INT(11) NOT NULL, 
   sale_price   INT(11) NOT NULL, -- 판매금액
   addTax       INT(11) NOT NULL, -- 부가세액
   supply_price INT(11) NOT NULL, -- 공급가액
   margin_Price  INT(11) NOT NULL, -- 마진액
   FOREIGN KEY (no) REFERENCES sale (no)
   on delete cascade
);

-- 하나의 테이블
CREATE TABLE salefull (
  no int(11) NOT NULL AUTO_INCREMENT,
  code char(4) NOT NULL,
  price int(11) NOT NULL,
  saleCnt int(11) NOT NULL,
  marginRate int(11) NOT NULL,
  sale_price int(11) NOT NULL,
  addtax int(11) NOT NULL,
  supply_price int(11) NOT NULL,
  margin_Price int(11) NOT NULL,
  PRIMARY KEY (no),
  FOREIGN KEY (code) REFERENCES product(code)
);

-- procedure drop
DROP PROCEDURE  if exists proc_saledetail_orderby;
DROP PROCEDURE  if exists proc_sale_stat;

-- trigger drop
DROP TRIGGER if exists tri_sale_insert_after_detail;
DROP TRIGGER if exists tri_sale_update_after_detail;
DROP TRIGGER if exists tri_sale_delete_after_detail;


-- procedure or trigger
CREATE PROCEDURE proc_saledetail_orderby (in isSalePrice boolean)
BEGIN
   set @score:=0, @rank:=0;
   
   select 
         greatest( @rank := if(@score = if(isSalePrice, saleprice, marginprice), @rank, @rank + 1),  
         least(0, @score := if(isSalePrice,saleprice,marginprice)) ) as rank,
         code, name, price, salecnt, supplyprice, addtax, saleprice, marginrate, marginprice
   from 
      (select no, s.code code, name, price , salecnt ,  
         @saleprice:=price*salecnt saleprice,
         @addtax := ceil(@saleprice/11) addtax,
         @supprice := @saleprice - @addtax supplyprice,
         marginrate ,
         @marPrice := round(@supprice * (marginrate/100)) marginprice
      from  sale s join product p on s.code = p.code ) t
   order by if(isSalePrice,saleprice,marginprice) desc;
END;


CREATE PROCEDURE proc_sale_stat()
BEGIN
	select  sum(@saleprice:=price*salecnt) sale_price, 
		sum(@addtax := ceil(@saleprice/11)) addtax_price, 
		sum(@supprice := @saleprice - @addtax) supply_price, 
		sum(@marPrice := round(@supprice * (marginrate/100))) margin_price 
	from  sale s join product p on s.code = p.code;
END;
 
 
CREATE PROCEDURE proc_salefull_insert(
    in _code char(4), 
    in _price integer,
    in _salecnt integer,
    in _marginRate integer )
BEGIN
	declare sale_price integer;
	declare addtax integer;
	declare supply_Price integer;
	declare margin_Price integer;
	
	set sale_price = _price * _salecnt;
	set addtax = ceil(sale_price/11);
	set supply_price = sale_price - addtax;
	set margin_Price = round(supply_price*(_marginRate/100));
	insert into salefull(code, price, salecnt, marginRate, sale_price, addtax, supply_price, margin_Price)
	values(_code, _price, _salecnt, _marginRate, sale_price, addtax, supply_price, margin_Price);
END;
 


-- trigger
create trigger tri_sale_insert_after_detail
after insert on sale
for each row
BEGIN
   set @saleprice = NEW.price * NEW.salecnt,
   @addtax = ceil(@saleprice/11),
   @supprice = @saleprice - @addtax,
   @marPrice = round(@supprice * (NEW.marginrate/100));
	
   INSERT INTO saledetail(no, sale_price, addTax, supply_price, margin_price)
   VALUES(NEW.no, @saleprice, @addtax, @supprice, @marPrice);
END;

create trigger tri_sale_update_after_detail
after update on sale
for each row
BEGIN
   set @saleprice = NEW.price * NEW.salecnt,
   @addtax = ceil(@saleprice/11),
   @supprice = @saleprice - @addtax,
   @marPrice = round(@supprice * (new.marginrate/100));
	
   UPDATE saledetail
   SET sale_price=@saleprice, addTax=@addtax, supply_price=@supprice, margin_price=@marPrice
   where no = new.no;
END;


create trigger tri_sale_delete_after_detail
after delete on sale
for each row
BEGIN
    delete from saledetail
    where no = old.no;
END;

